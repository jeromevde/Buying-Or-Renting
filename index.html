<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Financial Investment Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; font-size: 18px; }
        .container { max-width: 1400px; margin: auto; display: flex; flex-direction: row; }
        aside { width: 320px; min-width: 280px; margin-right: 40px; background: #f4f4f4; border-radius: 8px; padding: 24px 18px; }
        main { flex: 1; min-width: 0; }
        h1, h2 { text-align: center; }
        form, #fixedVarsForm { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }
        .form-row { display: flex; align-items: center; gap: 10px; }
        label { font-weight: bold; margin-bottom: 2px; min-width: 160px; font-size: 18px; }
        input, select { width: 110px; padding: 8px; margin-top: 2px; font-size: 18px; }
        .full-width { grid-column: 1 / span 2; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: right; font-size: 15px; }
        th { background: #f4f4f4; cursor: help; }
        tr:hover { background: #e9f7ef; }
        .scenario-list { margin-top: 20px; }
        #plot, #netWorthGraph { margin-top: 40px; margin-bottom: 20px; }
        fieldset { border: 1px solid #ccc; padding: 15px; }
        legend { font-weight: bold; }
        .collapsible {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            margin-top: 10px;
        }

        .active, .collapsible:hover {
            background-color: #ccc;
        }

        .content {
            padding: 0 0 10px 0;
            display: none;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        .ytab {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        .ytab th, .ytab td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
            position: relative;
        }
        .ytab th {
            background: #f4f4f4;
        }
        .tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            width: 220px;
            font-size: 13px;
            pointer-events: none;
        }
        .ytab td:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tabview { margin-top: 20px; }
        .tab-buttons { display: flex; gap: 12px; margin-bottom: 14px; }
        .tab-buttons button { padding: 10px 28px; border: none; background: #eee; cursor: pointer; font-size: 19px; border-radius: 4px; }
        .tab-buttons button.active { background: #ccc; font-weight: bold; }
        .tab-content { background: #f9f9f9; padding: 24px; border-radius: 6px; min-height: 120px; }
    </style>
</head>
<body>
<div class="container">
    <aside>
        <h2>Fixed Variables</h2>
        <form id="fixedVarsForm">
            <div class="form-row"><label for="cashAtHand">Cash at Hand (€)</label><input type="number" id="cashAtHand" value="100000"></div>
            <div class="form-row"><label for="interestRate">Interest Rate (%/year)</label><input type="number" id="interestRate" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="monthlyAllowance">Max Investable Monthly Allowance (€)</label><input type="number" id="monthlyAllowance" value="2000"></div>
            <div class="form-row"><label for="avgStockReturn">Avg. Stock Return (%/year)</label><input type="number" id="avgStockReturn" step="0.01" value="10.0"></div>
            <div class="form-row"><label for="avgRealEstateReturn">Avg. Real Estate Return (%/year)</label><input type="number" id="avgRealEstateReturn" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="avgBondReturn">Avg. Bond Return (%/year)</label><input type="number" id="avgBondReturn" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="prepaymentPenalty">Prepayment Penalty (% of remaining loan)</label><input type="number" id="prepaymentPenalty" step="0.01" value="1.0"></div>
            <div class="form-row"><label for="registrationTax">Registration Tax (% of house price)</label><input type="number" id="registrationTax" step="0.01" value="6.0"></div>
            <div class="form-row"><label for="maintenanceCosts">Maintenance Costs (% of house price/year)</label><input type="number" id="maintenanceCosts" step="0.01" value="1.0"></div>
        </form>
    </aside>
    <main style="flex: 1;">
        <h1> Financial Investment Simulator</h1>
        <canvas id="plot" width="1400" height="500" style="margin-bottom: 30px;"></canvas>
        <div id="netWorthGraph"></div>
        <div class="tabview">
            <div class="tab-buttons" id="tabButtons"></div>
            <div class="tab-content" id="tabContent"></div>
        </div>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const strategies = [
  { name: "Balanced", splits: { realEstate: 40, stocks: 40, bonds: 20 } },
  { name: "Aggressive Stocks", splits: { realEstate: 20, stocks: 70, bonds: 10 } },
  { name: "Conservative Bonds", splits: { realEstate: 20, stocks: 20, bonds: 60 } }
];

// Store latest input values and simulation results for each strategy
const strategyInputs = strategies.map(() => ({
  mode: 'buy',
  housePrice: 400000,
  initialDeposit: 80000,
  loanTerm: 25,
  monthlyRent: 1200,
  stocks: 40,
  bonds: 60,
  selectedTab: 'buy',
  simRows: []
}));

function renderTabButtons() {
  const tabButtons = document.getElementById('tabButtons');
  tabButtons.innerHTML = '';
  strategies.forEach((s, i) => {
    const btn = document.createElement('button');
    btn.textContent = s.name;
    btn.className = i === 0 ? 'active' : '';
    btn.onclick = () => selectStrategyTab(i);
    tabButtons.appendChild(btn);
  });
}

function selectStrategyTab(idx) {
  document.querySelectorAll('.tab-buttons button').forEach((b, i) => b.classList.toggle('active', i === idx));
  renderStrategyTab(idx);
}

function renderStrategyTab(idx) {
  const s = strategies[idx];
  const tabContent = document.getElementById('tabContent');
  // Remember selected tab for each strategy
  if (!strategyInputs[idx].selectedTab) strategyInputs[idx].selectedTab = 'buy';
  const selectedTab = strategyInputs[idx].selectedTab;
  tabContent.innerHTML = `
    <section style="margin-bottom: 18px; border: 2px solid #b0b0b0; border-radius: 8px; background: #f8f8f8; height: 220px; min-height: 220px; max-height: 220px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-start; min-width: 700px; padding: 0 32px;">
      <h3 style="margin: 10px 0 8px 0; padding-left: 12px; font-size: 20px; border-bottom: 1px solid #ccc;">Buy or Rent</h3>
      <div style="display: flex; flex: 1;">
        <div id="verticalTabButtons${idx}" style="display: flex; flex-direction: column; border-right: 1px solid #ccc; padding-right: 18px; margin-right: 18px;"></div>
        <div id="verticalTabContent${idx}" style="flex: 1;"></div>
      </div>
    </section>
    <section style="margin-bottom: 18px; border: 2px solid #b0b0b0; border-radius: 8px; background: #f8f8ff; height: 170px; min-height: 170px; max-height: 170px; overflow: hidden; display: flex; flex-direction: column; justify-content: flex-start; min-width: 700px; padding: 0 32px;">
      <h3 style="margin: 10px 0 8px 0; padding-left: 12px; font-size: 20px; border-bottom: 1px solid #ccc;">Stocks and Bonds</h3>
      <div id="remainderSection${idx}" style="margin-top: 8px; flex: 1;"></div>
    </section>
    <section style="border: 2px solid #b0b0b0; border-radius: 8px; background: #f9f9f9; height: 340px; min-height: 340px; max-height: 340px; overflow: auto; display: flex; flex-direction: column; justify-content: flex-start; min-width: 700px; padding: 0 32px;">
      <h3 style="margin: 10px 0 8px 0; padding-left: 12px; font-size: 20px; border-bottom: 1px solid #ccc;">Simulation Table</h3>
      <div id="strategyTable${idx}" style="flex: 1;"></div>
    </section>
  `;
  // Render the remembered tab and tab buttons
  renderVerticalTab(idx, selectedTab);
function renderVerticalTab(idx, mode) {
  // Render Buy/Rent tab buttons with correct indicator
  const tabBtnsDiv = document.getElementById(`verticalTabButtons${idx}`);
  tabBtnsDiv.innerHTML = '';
  ['buy', 'rent'].forEach(tab => {
    const btn = document.createElement('button');
    btn.id = (tab === 'buy' ? `buyTab${idx}` : `rentTab${idx}`);
    btn.className = 'vertical-tab' + (mode === tab ? ' active' : '');
    btn.textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
    btn.style = `padding: 10px 18px; border: none; background: #eee; cursor: pointer; font-size: 17px; border-radius: ${tab === 'buy' ? '4px 4px 0 0' : '0 0 4px 4px'}; margin-bottom: ${tab === 'buy' ? '2px' : '0'}; border-left: 6px solid ${mode === tab ? '#0074D9' : 'transparent'}; font-weight: ${mode === tab ? 'bold' : 'normal'};`;
    btn.onclick = () => {
      strategyInputs[idx].selectedTab = tab;
      // Only re-render the tabview, do not update the graph or simulation
      renderVerticalTab(idx, tab);
    };
    tabBtnsDiv.appendChild(btn);
  });
  const tabDiv = document.getElementById(`verticalTabContent${idx}`);
  if (mode === 'buy') {
    tabDiv.innerHTML = `
      <form id="strategyForm${idx}">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label>House Price (€)</label>
            <input type="number" name="housePrice" value="400000">
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label>Initial Deposit (€)</label>
            <input type="number" name="initialDeposit" value="80000">
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label>Loan Term (years)</label>
            <input type="number" name="loanTerm" value="25">
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; min-width: 180px; position: relative;">
            <label style="color: #555; font-style: italic;">Loan Monthly Payment (€)</label>
            <input type="number" name="monthlyRE" value="1200" readonly style="background: #f0f0f0; border: 1px solid #bbb; color: #333; font-weight: bold;">
            <span style="font-size: 12px; color: #888;">(calculated)</span>
            <span class="tooltip" style="bottom: 110%; left: 50%; transform: translateX(-50%);">Loan Monthly Payment (€) = (Loan Amount × Monthly Interest Rate) / (1 - (1 + Monthly Interest Rate)<sup>-Loan Term × 12</sup>)<br><br>Values will appear here.</span>
          </div>
          <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; min-width: 180px; position: relative;">
            <label style="color: #555; font-style: italic;">Monthly Maintenance Costs (€)</label>
            <input type="number" name="monthlyMaintenance" value="333" readonly style="background: #f0f0f0; border: 1px solid #bbb; color: #333; font-weight: bold;">
            <span style="font-size: 12px; color: #888;">(calculated)</span>
            <span class="tooltip" style="bottom: 110%; left: 50%; transform: translateX(-50%);">Monthly Maintenance Costs (€) = House Price × Maintenance Rate / 12<br><br>Values will appear here.</span>
          </div>
        </div>
        <div id="monthlyAllowanceMsg${idx}" style="color: #b00; font-weight: bold; margin: 8px 0;"></div>
      </form>
    `;
    // Add listeners for auto simulation
    const form = document.getElementById(`strategyForm${idx}`);
    ['housePrice','initialDeposit','loanTerm'].forEach(name => {
      form[name].addEventListener('input', () => {
        updateStrategyInputs(idx);
        runStrategySimulation(idx);
      });
    });
    updateStrategyInputs(idx);
    runStrategySimulation(idx);
  } else {
    tabDiv.innerHTML = `
      <form id="strategyForm${idx}">
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <label>Monthly Rent (€)</label>
            <input type="number" name="monthlyRent" value="1200">
          </div>
        </div>
        <div id="monthlyAllowanceMsg${idx}" style="color: #b00; font-weight: bold; margin: 8px 0;"></div>
      </form>
    `;
    // Add listeners for auto simulation
    const form = document.getElementById(`strategyForm${idx}`);
    form.monthlyRent.addEventListener('input', () => {
      updateStrategyInputs(idx, 'rent');
      runStrategySimulation(idx, 'rent');
    });
    updateStrategyInputs(idx, 'rent');
    runStrategySimulation(idx, 'rent');
  }
}
  // Add listeners for auto simulation
  const form = document.getElementById(`strategyForm${idx}`);
  // Add listeners for house price, deposit, term
  ['housePrice','initialDeposit','loanTerm'].forEach(name => {
    form[name].addEventListener('input', () => {
      updateStrategyInputs(idx);
      runStrategySimulation(idx);
    });
  });
  // Initial update
  updateStrategyInputs(idx);
  runStrategySimulation(idx);
}

function updateStrategyInputs(idx) {
  // Determine mode (buy/rent)
  const tabDiv = document.getElementById(`verticalTabContent${idx}`);
  const form = document.getElementById(`strategyForm${idx}`);
  let mode = 'buy';
  if (form && form.monthlyRent) mode = 'rent';
  strategyInputs[idx].mode = mode;
  if (mode === 'buy') {
    strategyInputs[idx].housePrice = +form.housePrice.value;
    strategyInputs[idx].initialDeposit = +form.initialDeposit.value;
    strategyInputs[idx].loanTerm = +form.loanTerm.value;
  } else {
    strategyInputs[idx].monthlyRent = +form.monthlyRent.value;
    strategyInputs[idx].loanTerm = 30;
  }
  const fixed = {
    cashAtHand: +document.getElementById('cashAtHand').value,
    monthlyAllowance: +document.getElementById('monthlyAllowance').value,
    interestRate: +document.getElementById('interestRate').value
  };
  let remainder = 0;
  let msgDiv = document.getElementById(`monthlyAllowanceMsg${idx}`);
  let remainderHtml = '';
  if (mode === 'buy') {
    const housePrice = +form.housePrice.value;
    const initialDeposit = +form.initialDeposit.value;
    const loanTerm = +form.loanTerm.value;
    if (initialDeposit > fixed.cashAtHand) {
      msgDiv.textContent = 'Error: Initial deposit cannot exceed cash at hand!';
    } else {
      msgDiv.textContent = '';
    }
    const loan = housePrice - initialDeposit;
    const monthlyLoanRate = (fixed.interestRate/100)/12;
    const monthlyRE = loan * monthlyLoanRate / (1 - Math.pow(1 + monthlyLoanRate, -loanTerm*12));
    form.monthlyRE.value = monthlyRE.toFixed(2);
    const maintenanceRate = +document.getElementById('maintenanceCosts').value;
    const monthlyMaintenance = housePrice * (maintenanceRate / 100) / 12;
    form.monthlyMaintenance.value = monthlyMaintenance.toFixed(2);
    remainder = fixed.monthlyAllowance - monthlyRE - monthlyMaintenance;
    remainderHtml = `<div style="display: flex; align-items: flex-end; gap: 16px; margin-bottom: 8px;">
      <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; position: relative;">
        <label style="color: #555; font-style: italic;">Remainder for Stocks/Bonds (€)</label>
        <input type="number" name="monthlyRemainder" value="${remainder > 0 ? remainder.toFixed(2) : 0}" readonly style="background: #f0f0f0; border: 1px solid #bbb; color: #333; font-weight: bold;">
        <span style="font-size: 12px; color: #888;">(calculated)</span>
        <span class="tooltip" style="bottom: 110%; left: 50%; transform: translateX(-50%);">Remainder for Stocks/Bonds (€) = Max Investable Monthly Allowance (€) - Loan Monthly Payment (€) - Monthly Maintenance Costs (€)<br><br>monthly allowance (${fixed.monthlyAllowance.toFixed(2)}) - loan (${monthlyRE.toFixed(2)}) - maintenance (${monthlyMaintenance.toFixed(2)}) = <b>${remainder > 0 ? remainder.toFixed(2) : 0}</b></span>
      </div>
      <div id="splitInputs${idx}" style="display: flex; gap: 12px; align-items: flex-end;"></div>
    </div>
    <div id="remainderMsg${idx}" style="color: #b00; font-weight: bold; margin: 8px 0;"></div>`;
  } else {
    // Rent mode
    const monthlyRent = +form.monthlyRent.value;
    remainder = fixed.monthlyAllowance - monthlyRent;
    remainderHtml = `<div style="display: flex; align-items: flex-end; gap: 16px; margin-bottom: 8px;">
      <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; position: relative;">
        <label style="color: #555; font-style: italic;">Remainder for Stocks/Bonds (€)</label>
        <input type="number" name="monthlyRemainder" value="${remainder > 0 ? remainder.toFixed(2) : 0}" readonly style="background: #f0f0f0; border: 1px solid #bbb; color: #333; font-weight: bold;">
        <span style="font-size: 12px; color: #888;">(calculated)</span>
        <span class="tooltip" style="bottom: 110%; left: 50%; transform: translateX(-50%);">Remainder for Stocks/Bonds (€) = Max Investable Monthly Allowance (€) - Monthly Rent (€)<br><br>monthly allowance (${fixed.monthlyAllowance.toFixed(2)}) - rent (${monthlyRent.toFixed(2)}) = <b>${remainder > 0 ? remainder.toFixed(2) : 0}</b></span>
      </div>
      <div id="splitInputs${idx}" style="display: flex; gap: 12px; align-items: flex-end;"></div>
    </div>
    <div id="remainderMsg${idx}" style="color: #b00; font-weight: bold; margin: 8px 0;"></div>`;
  }
  document.getElementById(`remainderSection${idx}`).innerHTML = remainderHtml;
  // Show split inputs only if remainder > 0
  const splitDiv = document.getElementById(`splitInputs${idx}`);
  if (remainder > 0) {
    const stocksPct = strategies[idx].splits.stocks;
    const bondsPct = 100 - stocksPct;
    const stocksVal = ((remainder * stocksPct / 100)).toFixed(2);
    const bondsVal = ((remainder * bondsPct / 100)).toFixed(2);
    splitDiv.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: flex-start;">
        <label style="font-size: 18px;">Stocks %</label>
        <input type="number" name="stocks" min="0" max="100" value="${stocksPct}" style="width: 60px; font-size: 18px; padding: 6px;">
        <span id="stocksNominal${idx}" style="font-size: 16px, color: #888, margin-top: 2px;">${stocksVal} €</span>
      </div>
      <div style="display: flex; flex-direction: column; align-items: flex-start;">
        <label style="font-size: 18px;">Bonds %</label>
        <input type="number" name="bonds" value="${bondsPct}" style="width: 60px; font-size: 18px; padding: 6px; background: #eee; color: #888;" readonly>
        <span id="bondsNominal${idx}" style="font-size: 16px, color: #888, margin-top: 2px;">${bondsVal} €</span>
      </div>
    `;
    splitDiv.querySelector("[name='stocks']").addEventListener('input', () => {
      const stocksInput = splitDiv.querySelector("[name='stocks']");
      let stocksPctNew = +stocksInput.value;
      if (stocksPctNew < 0) stocksPctNew = 0;
      if (stocksPctNew > 100) stocksPctNew = 100;
      strategies[idx].splits.stocks = stocksPctNew;
      const bondsPctNew = 100 - stocksPctNew;
      splitDiv.querySelector("[name='bonds']").value = bondsPctNew;
      splitDiv.querySelector(`#stocksNominal${idx}`).textContent = ((remainder * stocksPctNew / 100).toFixed(2)) + ' €';
      splitDiv.querySelector(`#bondsNominal${idx}`).textContent = ((remainder * bondsPctNew / 100).toFixed(2)) + ' €';
      runStrategySimulation(idx);
      updateNetWorthGraph();
    });
  } else {
    splitDiv.innerHTML = '';
  }
  // Error message
  const remainderMsg = document.getElementById(`remainderMsg${idx}`);
  if (remainder < 0) {
    remainderMsg.textContent = mode === 'buy' ? 'Error: Monthly real estate payment plus maintenance exceeds max investable monthly allowance!' : 'Error: Monthly rent exceeds max investable monthly allowance!';
  } else {
    remainderMsg.textContent = '';
  }
}

// Add listeners for fixed variables to auto-update all strategies and graph
function addFixedVarListeners() {
  const fixedForm = document.getElementById('fixedVarsForm');
  Array.from(fixedForm.elements).forEach(el => {
    el.addEventListener('input', () => {
      // Re-render all tabs and update graph
      renderTabButtons();
      renderStrategyTab(document.querySelector('.tab-buttons button.active')?.textContent === strategies[0].name ? 0 :
                        document.querySelector('.tab-buttons button.active')?.textContent === strategies[1].name ? 1 : 2);
      updateNetWorthGraph();
    });
  });
  // Add listeners for strategy inputs to update graph for all strategies
  for (let idx = 0; idx < strategies.length; idx++) {
    const form = document.getElementById(`strategyForm${idx}`);
    if (form) {
      Array.from(form.elements).forEach(el => {
        if (el.type === 'number' && !el.readOnly) {
          el.addEventListener('input', () => {
            // Rerun all strategy simulations
            for (let idx = 0; idx < strategies.length; idx++) {
              runStrategySimulation(idx);
            }
            updateNetWorthGraph();
          });
        }
      });
    }
  }
}

function runStrategySimulation(idx) {
  // Get fixed vars
  const fixed = {
    cashAtHand: +document.getElementById('cashAtHand').value,
    interestRate: +document.getElementById('interestRate').value,
    monthlyAllowance: +document.getElementById('monthlyAllowance').value,
    avgStockReturn: +document.getElementById('avgStockReturn').value,
    avgRealEstateReturn: +document.getElementById('avgRealEstateReturn').value,
    avgBondReturn: +document.getElementById('avgBondReturn').value,
    prepaymentPenalty: +document.getElementById('prepaymentPenalty').value,
    registrationTax: +document.getElementById('registrationTax').value,
    maintenanceCosts: +document.getElementById('maintenanceCosts').value
  };
  // Get strategy vars
  const form = document.getElementById(`strategyForm${idx}`);
  let mode = 'buy';
  if (form && form.monthlyRent) mode = 'rent';
  let housePrice = 0, initialDeposit = 0, loanTerm = 0, monthlyRE = 0, monthlyRemainder = 0;
  let stocks = 0, bonds = 0;
  if (form) {
    if (mode === 'buy') {
      housePrice = form.housePrice ? +form.housePrice.value : 0;
      initialDeposit = form.initialDeposit ? +form.initialDeposit.value : 0;
      loanTerm = form.loanTerm ? +form.loanTerm.value : 0;
      monthlyRE = form.monthlyRE ? +form.monthlyRE.value : 0;
      monthlyRemainder = form.monthlyRemainder ? +form.monthlyRemainder.value : 0;
    } else {
      // Rent mode: set buy-related fields to zero/defaults
      housePrice = 0;
      initialDeposit = 0;
      loanTerm = 30; // Default simulation length for rent
      monthlyRE = 0;
      monthlyRemainder = form.monthlyRemainder ? +form.monthlyRemainder.value : 0;
    }
    if (monthlyRemainder > 0) {
      stocks = form.querySelector("[name='stocks']") ? +form.querySelector("[name='stocks']").value : strategies[idx].splits.stocks;
      bonds = form.querySelector("[name='bonds']") ? +form.querySelector("[name='bonds']").value : strategies[idx].splits.bonds;
    }
  } else {
    // fallback to default strategy values if form not rendered yet
    housePrice = 400000;
    initialDeposit = 80000;
    loanTerm = 30;
    monthlyRE = 1200;
    monthlyRemainder = 800;
    stocks = strategies[idx].splits.stocks;
    bonds = strategies[idx].splits.bonds;
  }
  const result = simulateStrategy(fixed, housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds);
  strategyInputs[idx].simRows = result;
  renderStrategyTable(idx, result);
  // Only update the graph if simulation data changed, not on tab switch
  if (typeof idx === 'number') updateNetWorthGraph(idx);
}

function simulateStrategy(fixed, housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds) {
  // Always simulate up to maxYears (from updateNetWorthGraph)
  const maxYears = Math.max(...strategyInputs.map(input => input.loanTerm));
  let rows = [];
let registrationTax = housePrice * (fixed.registrationTax/100);
let investedCash = fixed.cashAtHand - initialDeposit - registrationTax;
let realEstateValue = housePrice;
let realEstateBalance = housePrice - initialDeposit - registrationTax;
let stockBalance = investedCash * (stocks/100);
let bondBalance = investedCash * (bonds/100);
let loanBalance = housePrice - initialDeposit + registrationTax;
  let lastRow = null;
  for (let y = 0; y <= maxYears; y++) {
    let penalty = 0;
    if (loanBalance > 0 && y < loanTerm) {
      penalty = loanBalance * (fixed.prepaymentPenalty/100);
    }
    if (y > 0) {
      realEstateValue *= (1 + fixed.avgRealEstateReturn/100);
      stockBalance = (stockBalance + (monthlyRemainder/12) * (stocks/100) * 12) * (1 + fixed.avgStockReturn/100);
      bondBalance = (bondBalance + (monthlyRemainder/12) * (bonds/100) * 12) * (1 + fixed.avgBondReturn/100);
      // Amortize loan only for loanTerm years
      if (y <= loanTerm) {
        let monthlyLoanRate = (fixed.interestRate/100)/12;
        let interestPaid = loanBalance * monthlyLoanRate * 12;
        let principalPaid = Math.min(monthlyRE * 12 - interestPaid, loanBalance);
        loanBalance -= principalPaid;
        if (loanBalance < 0) loanBalance = 0;
      }
    }
    let netWorth = realEstateValue + stockBalance + bondBalance - loanBalance - penalty;
    let row = {
      year: y,
      realEstateValue,
      stockBalance,
      bondBalance,
      loanBalance,
      penalty,
      maintenance: 0,
      netWorth
    };
    rows.push(row);
    lastRow = row;
  }
  return rows;
}

function renderStrategyTable(idx, rows) {
  let html = `<table class="ytab"><thead><tr>
    <th>Year</th>
    <th>Real Estate Value</th>
    <th>Stock Balance</th>
    <th>Bond Balance</th>
    <th>Loan Balance</th>
    <th>Prepayment Penalty</th>
    <th>Net Worth</th>
  </tr></thead><tbody>`;
  for (const r of rows) {
    html += `<tr>
      <td>${r.year}</td>
      <td>${r.realEstateValue.toFixed(2)}<span class="tooltip">Real Estate Value = Previous × (1 + Real Estate Return)</span></td>
      <td>${r.stockBalance.toFixed(2)}<span class="tooltip">Stock Balance = Previous × (1 + Stock Return)</span></td>
      <td>${r.bondBalance.toFixed(2)}<span class="tooltip">Bond Balance = Previous × (1 + Bond Return)</span></td>
      <td>${r.loanBalance.toFixed(2)}<span class="tooltip">Loan Balance = Remaining mortgage principal + registration tax</span></td>
      <td>${r.penalty.toFixed(2)}<span class="tooltip">Prepayment Penalty = Remaining Loan × Penalty Rate (if not last year)</span></td>
      <td>${r.netWorth.toFixed(2)}<span class="tooltip">Net Worth = Real Estate + Stocks + Bonds - Loan Balance - Penalty</span></td>
    </tr>`;
  }
  html += '</tbody></table>';
  const tableDiv = document.getElementById(`strategyTable${idx}`);
  if (tableDiv) tableDiv.innerHTML = html;
}

function updateNetWorthGraph(changedIdx) {
  // Always show all three graphs, but only update the changed strategy's data if changedIdx is provided
  const cashAtHand = +document.getElementById('cashAtHand').value;
  // Find the union of all years across all strategies
  let allYears = new Set();
  for (let i = 0; i < strategies.length; i++) {
    const simRows = strategyInputs[i].simRows || [];
    simRows.forEach(r => allYears.add(r.year));
  }
  if (allYears.size === 0) return;
  let years = Array.from(allYears).sort((a, b) => a - b);
  years = [-1, ...years];
  // Build datasets for all strategies
  let datasets = strategies.map((s, idx) => {
    const simRows = strategyInputs[idx].simRows || [];
    const data = years.map(y => {
      if (y === -1) return cashAtHand;
      const row = simRows.find(r => r.year === y);
      return row ? row.netWorth : null;
    });
    return {
      label: s.name,
      data,
      borderColor: idx === 0 ? 'blue' : idx === 1 ? 'green' : 'orange',
      fill: false,
      tension: 0.1
    };
  });
  const ctx = document.getElementById('plot').getContext('2d');
  if (window.resultChart) window.resultChart.destroy();
  window.resultChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: years,
      datasets: datasets
    },
    options: {
      responsive: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { enabled: true }
      },
      scales: {
        x: { title: { display: true, text: 'Year' } },
        y: {
          title: { display: true, text: 'Net Worth (€)' },
          beginAtZero: true,
          suggestedMin: 0,
          suggestedMax: Math.max(...datasets.flatMap(ds => ds.data.filter(v => v !== null))) * 1.1
        }
      }
    }
  });
}

window.onload = function() {
  renderTabButtons();
  renderStrategyTab(0);
  addFixedVarListeners();
  updateNetWorthGraph();
};
</script>
</body>
</html>
