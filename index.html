<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy vs Invest Financial Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; font-size: 18px; }
        .container { max-width: 1400px; margin: auto; display: flex; flex-direction: row; }
        aside { width: 320px; min-width: 280px; margin-right: 40px; background: #f4f4f4; border-radius: 8px; padding: 24px 18px; }
        main { flex: 1; min-width: 0; }
        h1, h2 { text-align: center; }
        form, #fixedVarsForm { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }
        .form-row { display: flex; align-items: center; gap: 10px; }
        label { font-weight: bold; margin-bottom: 2px; min-width: 160px; font-size: 18px; }
        input, select { width: 110px; padding: 8px; margin-top: 2px; font-size: 18px; }
        .full-width { grid-column: 1 / span 2; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: right; font-size: 15px; }
        th { background: #f4f4f4; cursor: help; }
        tr:hover { background: #e9f7ef; }
        .scenario-list { margin-top: 20px; }
        #plot, #netWorthGraph { margin-top: 40px; margin-bottom: 20px; }
        fieldset { border: 1px solid #ccc; padding: 15px; }
        legend { font-weight: bold; }
        .collapsible {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            margin-top: 10px;
        }

        .active, .collapsible:hover {
            background-color: #ccc;
        }

        .content {
            padding: 0 0 10px 0;
            display: none;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        .ytab {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        .ytab th, .ytab td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
            position: relative;
        }
        .ytab th {
            background: #f4f4f4;
        }
        .tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            width: 220px;
            font-size: 13px;
            pointer-events: none;
        }
        .ytab td:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tabview { margin-top: 20px; }
        .tab-buttons { display: flex; gap: 12px; margin-bottom: 14px; }
        .tab-buttons button { padding: 10px 28px; border: none; background: #eee; cursor: pointer; font-size: 19px; border-radius: 4px; }
        .tab-buttons button.active { background: #ccc; font-weight: bold; }
        .tab-content { background: #f9f9f9; padding: 24px; border-radius: 6px; min-height: 120px; }
    </style>
</head>
<body>
<div class="container">
    <aside>
        <h2>Fixed Variables</h2>
        <form id="fixedVarsForm">
            <div class="form-row"><label for="cashAtHand">Cash at Hand (€)</label><input type="number" id="cashAtHand" value="100000"></div>
            <div class="form-row"><label for="interestRate">Interest Rate (%/year)</label><input type="number" id="interestRate" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="monthlyAllowance">Max Investable Monthly Allowance (€)</label><input type="number" id="monthlyAllowance" value="2000"></div>
            <div class="form-row"><label for="avgStockReturn">Avg. Stock Return (%/year)</label><input type="number" id="avgStockReturn" step="0.01" value="10.0"></div>
            <div class="form-row"><label for="avgRealEstateReturn">Avg. Real Estate Return (%/year)</label><input type="number" id="avgRealEstateReturn" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="avgBondReturn">Avg. Bond Return (%/year)</label><input type="number" id="avgBondReturn" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="prepaymentPenalty">Prepayment Penalty (% of remaining loan)</label><input type="number" id="prepaymentPenalty" step="0.01" value="1.0"></div>
            <div class="form-row"><label for="registrationTax">Registration Tax (% of house price)</label><input type="number" id="registrationTax" step="0.01" value="6.0"></div>
            <div class="form-row"><label for="maintenanceCosts">Maintenance Costs (% of house price/year)</label><input type="number" id="maintenanceCosts" step="0.01" value="1.0"></div>
        </form>
    </aside>
    <main style="flex: 1;">
        <h1>Buy vs Invest Financial Simulator</h1>
        <canvas id="plot" width="1400" height="500" style="margin-bottom: 30px;"></canvas>
        <div id="netWorthGraph"></div>
        <div class="tabview">
            <div class="tab-buttons" id="tabButtons"></div>
            <div class="tab-content" id="tabContent"></div>
        </div>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const strategies = [
  { name: "Balanced", splits: { realEstate: 40, stocks: 40, bonds: 20 } },
  { name: "Aggressive Stocks", splits: { realEstate: 20, stocks: 70, bonds: 10 } },
  { name: "Conservative Bonds", splits: { realEstate: 20, stocks: 20, bonds: 60 } }
];

function renderTabButtons() {
  const tabButtons = document.getElementById('tabButtons');
  tabButtons.innerHTML = '';
  strategies.forEach((s, i) => {
    const btn = document.createElement('button');
    btn.textContent = s.name;
    btn.className = i === 0 ? 'active' : '';
    btn.onclick = () => selectStrategyTab(i);
    tabButtons.appendChild(btn);
  });
}

function selectStrategyTab(idx) {
  document.querySelectorAll('.tab-buttons button').forEach((b, i) => b.classList.toggle('active', i === idx));
  renderStrategyTab(idx);
}

function renderStrategyTab(idx) {
  const s = strategies[idx];
  const tabContent = document.getElementById('tabContent');
  tabContent.innerHTML = `
    <form id="strategyForm${idx}">
      <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">
        <div style="display: flex; flex-direction: column; gap: 6px;">
          <label>House Price (€)</label>
          <input type="number" name="housePrice" value="400000">
        </div>
        <div style="display: flex; flex-direction: column; gap: 6px;">
          <label>Initial Deposit (€)</label>
          <input type="number" name="initialDeposit" value="80000">
        </div>
        <div style="display: flex; flex-direction: column; gap: 6px;">
          <label>Loan Term (years)</label>
          <input type="number" name="loanTerm" value="25">
        </div>
        <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; min-width: 180px; position: relative;">
          <label style="color: #555; font-style: italic;">Loan Monthly Payment (€)</label>
          <input type="number" name="monthlyRE" value="1200" readonly style="background: #f0f0f0; border: 1px solid #bbb; color: #333; font-weight: bold;">
          <span style="font-size: 12px; color: #888;">(calculated)</span>
          <span class="tooltip" style="bottom: 110%; left: 50%; transform: translateX(-50%);">Loan Monthly Payment (€) = (Loan Amount × Monthly Interest Rate) / (1 - (1 + Monthly Interest Rate)<sup>-Loan Term × 12</sup>)<br><br>Values will appear here.</span>
        </div>
        <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; min-width: 180px; position: relative;">
          <label style="color: #555; font-style: italic;">Monthly Maintenance Costs (€)</label>
          <input type="number" name="monthlyMaintenance" value="333" readonly style="background: #f0f0f0; border: 1px solid #bbb; color: #333; font-weight: bold;">
          <span style="font-size: 12px; color: #888;">(calculated)</span>
          <span class="tooltip" style="bottom: 110%; left: 50%; transform: translateX(-50%);">Monthly Maintenance Costs (€) = House Price × Maintenance Rate / 12<br><br>Values will appear here.</span>
        </div>
      </div>
      <div id="monthlyAllowanceMsg${idx}" style="color: #b00; font-weight: bold; margin: 8px 0;"></div>
      <div style="display: flex; align-items: flex-end; gap: 16px; margin-bottom: 8px;">
        <div style="display: flex; flex-direction: column; gap: 6px; align-items: flex-start; position: relative;">
          <label style="color: #555; font-style: italic;">Remainder for Stocks/Bonds (€)</label>
          <input type="number" name="monthlyRemainder" value="800" readonly style="background: #f0f0f0; border: 1px solid #bbb; color: #333; font-weight: bold;">
          <span style="font-size: 12px; color: #888;">(calculated)</span>
          <span class="tooltip" style="bottom: 110%; left: 50%; transform: translateX(-50%);">Remainder for Stocks/Bonds (€) = Max Investable Monthly Allowance (€) - Loan Monthly Payment (€) - Monthly Maintenance Costs (€)<br><br>This is the amount available per month for stocks/bonds investment after paying the loan and maintenance.</span>
        </div>
        <div id="splitInputs${idx}" style="display: flex; gap: 12px; align-items: flex-end;"></div>
      </div>
      <div id="remainderMsg${idx}" style="color: #b00; font-weight: bold; margin: 8px 0;"></div>
    </form>
    <div id="strategyTable${idx}"></div>
  `;
  // Add listeners for auto simulation
  const form = document.getElementById(`strategyForm${idx}`);
  // Add listeners for house price, deposit, term
  ['housePrice','initialDeposit','loanTerm'].forEach(name => {
    form[name].addEventListener('input', () => {
      updateStrategyInputs(idx);
      runStrategySimulation(idx);
    });
  });
  // Initial update
  updateStrategyInputs(idx);
  runStrategySimulation(idx);
}

function updateStrategyInputs(idx) {
  const fixed = {
    cashAtHand: +document.getElementById('cashAtHand').value,
    monthlyAllowance: +document.getElementById('monthlyAllowance').value,
    interestRate: +document.getElementById('interestRate').value
  };
  const form = document.getElementById(`strategyForm${idx}`);
  const housePrice = +form.housePrice.value;
  const initialDeposit = +form.initialDeposit.value;
  const loanTerm = +form.loanTerm.value;
  // Check deposit vs cash at hand
  const msgDiv = document.getElementById(`monthlyAllowanceMsg${idx}`);
  if (initialDeposit > fixed.cashAtHand) {
    msgDiv.textContent = 'Error: Initial deposit cannot exceed cash at hand!';
  } else {
    msgDiv.textContent = '';
  }
  // Calculate monthly payment for real estate
  const loan = housePrice - initialDeposit;
  const monthlyLoanRate = (fixed.interestRate/100)/12;
  const monthlyRE = loan * monthlyLoanRate / (1 - Math.pow(1 + monthlyLoanRate, -loanTerm*12));
  form.monthlyRE.value = monthlyRE.toFixed(2);
  // Calculate monthly maintenance cost
  const maintenanceRate = +document.getElementById('maintenanceCosts').value;
  const monthlyMaintenance = housePrice * (maintenanceRate / 100) / 12;
  form.monthlyMaintenance.value = monthlyMaintenance.toFixed(2);
  // Check monthly allowance
  let remainder = fixed.monthlyAllowance - monthlyRE - monthlyMaintenance;
  form.monthlyRemainder.value = remainder > 0 ? remainder.toFixed(2) : 0;
  // Add hover tooltip to remainder input (for accessibility, in addition to custom tooltip)
  form.monthlyRemainder.title = "Remainder for Stocks/Bonds (€) = Max Investable Monthly Allowance - Loan Monthly Payment - Monthly Maintenance Costs";
  // Show/hide custom tooltip on hover for remainder
  const remainderInput = form.monthlyRemainder;
  const remainderTooltip = remainderInput.parentElement.querySelector('.tooltip');
  if (remainderTooltip) {
    // Get actual values for the formula
    const allowance = fixed.monthlyAllowance.toFixed(2);
    const loanPay = monthlyRE.toFixed(2);
    const maint = monthlyMaintenance.toFixed(2);
    const remainderVal = form.monthlyRemainder.value;
    remainderTooltip.innerHTML = `monthly allowance (${allowance}) - loan (${loanPay}) - maintenance (${maint}) = <b>${remainderVal}</b>`;
    remainderInput.addEventListener('mouseenter', () => { remainderTooltip.style.visibility = 'visible'; remainderTooltip.style.opacity = '1'; });
    remainderInput.addEventListener('mouseleave', () => { remainderTooltip.style.visibility = 'hidden'; remainderTooltip.style.opacity = '0'; });
  }
  // Show/hide custom tooltip on hover for loan monthly payment
  const loanInput = form.monthlyRE;
  const loanTooltip = loanInput.parentElement.querySelector('.tooltip');
  if (loanTooltip) {
    const loanAmount = housePrice - initialDeposit;
    const monthlyRate = (fixed.interestRate/100/12).toFixed(5);
    const nMonths = loanTerm*12;
    loanTooltip.innerHTML = `Loan Monthly Payment (€) = (Loan Amount × Monthly Interest Rate) / (1 - (1 + Monthly Interest Rate)<sup>-${nMonths}</sup>)<br><br>Values: loan (${loanAmount}) × rate (${monthlyRate}) / (1 - (1 + ${monthlyRate})<sup>-${nMonths}</sup>) = <b>${form.monthlyRE.value}</b>`;
    loanInput.addEventListener('mouseenter', () => { loanTooltip.style.visibility = 'visible'; loanTooltip.style.opacity = '1'; });
    loanInput.addEventListener('mouseleave', () => { loanTooltip.style.visibility = 'hidden'; loanTooltip.style.opacity = '0'; });
  }
  // Show/hide custom tooltip on hover for monthly maintenance
  const maintInput = form.monthlyMaintenance;
  const maintTooltip = maintInput.parentElement.querySelector('.tooltip');
  if (maintTooltip) {
    maintTooltip.innerHTML = `Monthly Maintenance Costs (€) = House Price × Maintenance Rate / 12<br><br>Values: ${housePrice} × ${document.getElementById('maintenanceCosts').value}% / 12 = <b>${form.monthlyMaintenance.value}</b>`;
    maintInput.addEventListener('mouseenter', () => { maintTooltip.style.visibility = 'visible'; maintTooltip.style.opacity = '1'; });
    maintInput.addEventListener('mouseleave', () => { maintTooltip.style.visibility = 'hidden'; maintTooltip.style.opacity = '0'; });
  }
  const remainderMsg = document.getElementById(`remainderMsg${idx}`);
  if (remainder < 0) {
    remainderMsg.textContent = 'Error: Monthly real estate payment plus maintenance exceeds max investable monthly allowance!';
  } else {
    remainderMsg.textContent = '';
  }
  // Show split inputs only if remainder > 0
  const splitDiv = document.getElementById(`splitInputs${idx}`);
  if (remainder > 0) {
    const stocksPct = strategies[idx].splits.stocks;
    const bondsPct = 100 - stocksPct;
    const stocksVal = ((remainder * stocksPct / 100)).toFixed(2);
    const bondsVal = ((remainder * bondsPct / 100)).toFixed(2);
    splitDiv.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: flex-start;">
        <label style="font-size: 18px;">Stocks %</label>
        <input type="number" name="stocks" min="0" max="100" value="${stocksPct}" style="width: 60px; font-size: 18px; padding: 6px;">
        <span id="stocksNominal${idx}" style="font-size: 16px; color: #888; margin-top: 2px;">${stocksVal} €</span>
      </div>
      <div style="display: flex; flex-direction: column; align-items: flex-start;">
        <label style="font-size: 18px;">Bonds %</label>
        <input type="number" name="bonds" value="${bondsPct}" style="width: 60px; font-size: 18px; padding: 6px; background: #eee; color: #888;" readonly>
        <span id="bondsNominal${idx}" style="font-size: 16px; color: #888; margin-top: 2px;">${bondsVal} €</span>
      </div>
    `;
    // Add listener for stocks input only
    splitDiv.querySelector("[name='stocks']").addEventListener('input', () => {
      const stocksInput = splitDiv.querySelector("[name='stocks']");
      let stocksPctNew = +stocksInput.value;
      if (stocksPctNew < 0) stocksPctNew = 0;
      if (stocksPctNew > 100) stocksPctNew = 100;
      strategies[idx].splits.stocks = stocksPctNew;
      const bondsPctNew = 100 - stocksPctNew;
      splitDiv.querySelector("[name='bonds']").value = bondsPctNew;
      splitDiv.querySelector(`#stocksNominal${idx}`).textContent = ((remainder * stocksPctNew / 100).toFixed(2)) + ' €';
      splitDiv.querySelector(`#bondsNominal${idx}`).textContent = ((remainder * bondsPctNew / 100).toFixed(2)) + ' €';
      runStrategySimulation(idx);
    });
  } else {
    splitDiv.innerHTML = '';
  }
}

// Add listeners for fixed variables to auto-update all strategies and graph
function addFixedVarListeners() {
  const fixedForm = document.getElementById('fixedVarsForm');
  Array.from(fixedForm.elements).forEach(el => {
    el.addEventListener('input', () => {
      // Re-render all tabs and update graph
      renderTabButtons();
      renderStrategyTab(document.querySelector('.tab-buttons button.active')?.textContent === strategies[0].name ? 0 :
                        document.querySelector('.tab-buttons button.active')?.textContent === strategies[1].name ? 1 : 2);
      updateNetWorthGraph();
    });
  });
}

function runStrategySimulation(idx) {
  // Get fixed vars
  const fixed = {
    cashAtHand: +document.getElementById('cashAtHand').value,
    interestRate: +document.getElementById('interestRate').value,
    monthlyAllowance: +document.getElementById('monthlyAllowance').value,
    avgStockReturn: +document.getElementById('avgStockReturn').value,
    avgRealEstateReturn: +document.getElementById('avgRealEstateReturn').value,
    avgBondReturn: +document.getElementById('avgBondReturn').value,
    prepaymentPenalty: +document.getElementById('prepaymentPenalty').value,
    registrationTax: +document.getElementById('registrationTax').value,
    maintenanceCosts: +document.getElementById('maintenanceCosts').value
  };
  // Get strategy vars
  const form = document.getElementById(`strategyForm${idx}`);
  const housePrice = +form.housePrice.value;
  const initialDeposit = +form.initialDeposit.value;
  const loanTerm = +form.loanTerm.value;
  const monthlyRE = +form.monthlyRE.value;
  const monthlyRemainder = +form.monthlyRemainder.value;
  let stocks = 0, bonds = 0;
  if (monthlyRemainder > 0) {
    stocks = form.querySelector("[name='stocks']") ? +form.querySelector("[name='stocks']").value : strategies[idx].splits.stocks;
    bonds = form.querySelector("[name='bonds']") ? +form.querySelector("[name='bonds']").value : strategies[idx].splits.bonds;
  }
  // Simulate strategy
  const result = simulateStrategy(fixed, housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds);
  renderStrategyTable(idx, result);
  updateNetWorthGraph();
}

function simulateStrategy(fixed, housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds) {
  const years = loanTerm;
  let rows = [];
  // Initial cash at hand
  let investedCash = fixed.cashAtHand - initialDeposit;
  let registrationTax = housePrice * (fixed.registrationTax/100);
  let realEstateValue = housePrice;
  let realEstateBalance = housePrice - initialDeposit;
  let stockBalance = investedCash * (stocks/100);
  let bondBalance = investedCash * (bonds/100);
  let loanBalance = housePrice - initialDeposit;
  for (let y = 0; y <= years; y++) {
    let penalty = 0;
    if (loanBalance > 0 && y < years) {
      penalty = loanBalance * (fixed.prepaymentPenalty/100);
    }
    // maintenance is now part of the investible amount, not subtracted from net worth
    if (y > 0) {
      realEstateValue *= (1 + fixed.avgRealEstateReturn/100);
      // Use monthlyRemainder divided by 12 for monthly investment
      stockBalance = (stockBalance + (monthlyRemainder/12) * (stocks/100) * 12) * (1 + fixed.avgStockReturn/100);
      bondBalance = (bondBalance + (monthlyRemainder/12) * (bonds/100) * 12) * (1 + fixed.avgBondReturn/100);
      // Amortize loan
      let monthlyLoanRate = (fixed.interestRate/100)/12;
      let interestPaid = loanBalance * monthlyLoanRate * 12;
      let principalPaid = Math.min(monthlyRE * 12 - interestPaid, loanBalance);
      loanBalance -= principalPaid;
      if (loanBalance < 0) loanBalance = 0;
    }
    // Net worth = real estate + stocks + bonds - loan balance - penalty - registration tax (only at t=0)
    let netWorth = realEstateValue + stockBalance + bondBalance - loanBalance - penalty;
    if (y === 0) netWorth -= registrationTax;
    rows.push({
      year: y,
      realEstateValue,
      stockBalance,
      bondBalance,
      loanBalance,
      penalty,
      registrationTax: y === 0 ? registrationTax : 0,
      maintenance: 0,
      netWorth
    });
  }
  return rows;
}

function renderStrategyTable(idx, rows) {
  let html = `<table class="ytab"><thead><tr>
    <th>Year</th>
    <th>Real Estate Value</th>
    <th>Stock Balance</th>
    <th>Bond Balance</th>
    <th>Loan Balance</th>
    <th>Prepayment Penalty</th>
    <th>Registration Tax</th>
    <th>Net Worth</th>
  </tr></thead><tbody>`;
  for (const r of rows) {
    html += `<tr>
      <td>${r.year}</td>
      <td>${r.realEstateValue.toFixed(2)}<span class="tooltip">Real Estate Value = Previous × (1 + Real Estate Return)</span></td>
      <td>${r.stockBalance.toFixed(2)}<span class="tooltip">Stock Balance = Previous × (1 + Stock Return)</span></td>
      <td>${r.bondBalance.toFixed(2)}<span class="tooltip">Bond Balance = Previous × (1 + Bond Return)</span></td>
      <td>${r.loanBalance.toFixed(2)}<span class="tooltip">Loan Balance = Remaining mortgage principal</span></td>
      <td>${r.penalty.toFixed(2)}<span class="tooltip">Prepayment Penalty = Remaining Loan × Penalty Rate (if not last year)</span></td>
      <td>${r.registrationTax.toFixed(2)}<span class="tooltip">Registration Tax = House Price × Registration Tax Rate (only at t=0)</span></td>
      <td>${r.netWorth.toFixed(2)}<span class="tooltip">Net Worth = Real Estate + Stocks + Bonds - Loan Balance - Penalty - Registration Tax (t=0)</span></td>
    </tr>`;
  }
  html += '</tbody></table>';
  document.getElementById(`strategyTable${idx}`).innerHTML = html;
}

function updateNetWorthGraph() {
  // For each strategy, get net worth over time
  let datasets = [];
  strategies.forEach((s, idx) => {
    const fixed = {
      interestRate: +document.getElementById('interestRate').value,
      monthlyAllowance: +document.getElementById('monthlyAllowance').value,
      avgStockReturn: +document.getElementById('avgStockReturn').value,
      avgRealEstateReturn: +document.getElementById('avgRealEstateReturn').value,
      avgBondReturn: +document.getElementById('avgBondReturn').value,
      cashAtHand: +document.getElementById('cashAtHand').value
    };
    // Always use the current values from the tab forms
    const form = document.getElementById(`strategyForm${idx}`);
    let housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds;
    if (form) {
      housePrice = +form.housePrice.value;
      initialDeposit = +form.initialDeposit.value;
      loanTerm = +form.loanTerm.value;
      monthlyRE = +form.monthlyRE.value;
      monthlyRemainder = +form.monthlyRemainder.value;
      if (monthlyRemainder > 0) {
        stocks = form.querySelector("[name='stocks']") ? +form.querySelector("[name='stocks']").value : s.splits.stocks;
        bonds = form.querySelector("[name='bonds']") ? +form.querySelector("[name='bonds']").value : s.splits.bonds;
      } else {
        stocks = 0;
        bonds = 0;
      }
    } else {
      // fallback to default strategy values if form not rendered yet
      housePrice = 400000;
      initialDeposit = 80000;
      loanTerm = 30;
      monthlyRE = 1200;
      monthlyRemainder = 800;
      stocks = s.splits.stocks;
      bonds = s.splits.bonds;
    }
    const rows = simulateStrategy(fixed, housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds);
    datasets.push({
      label: s.name,
      data: rows.map(r => r.netWorth),
      borderColor: idx === 0 ? 'blue' : idx === 1 ? 'green' : 'orange',
      fill: false,
      tension: 0.1
    });
  });
  // Use the max loan term among all strategies for x axis
  const maxYears = Math.max(...strategies.map((s, idx) => {
    const form = document.getElementById(`strategyForm${idx}`);
    return form ? +form.loanTerm.value : 30;
  }));
  const years = Array.from({length: maxYears + 1}, (_, i) => i);
  const ctx = document.getElementById('plot').getContext('2d');
  if (window.resultChart) window.resultChart.destroy();
  window.resultChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: years,
      datasets: datasets
    },
    options: {
      responsive: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { enabled: true }
      },
      scales: {
        x: { title: { display: true, text: 'Year' } },
        y: { title: { display: true, text: 'Net Worth (€)' } }
      }
    }
  });
}

window.onload = function() {
  renderTabButtons();
  renderStrategyTab(0);
  addFixedVarListeners();
  updateNetWorthGraph();
};
</script>
</body>
</html>
