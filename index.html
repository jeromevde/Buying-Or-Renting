<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Investment Simulator</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; font-size: 18px; }
        .container { max-width: 1400px; margin: auto; display: flex; flex-direction: row; }
        aside { width: 320px; min-width: 250px; margin-right: 40px; background: #f4f4f4; border-radius: 8px; padding: 24px 18px; }
        main { flex: 1; min-width: 0; }
        h1, h2 { text-align: center; }
        form, #fixedVarsForm { display: flex; flex-direction: column; gap: 12px; margin-bottom: 30px; }
        .form-row { display: flex; align-items: center; gap: 10px; }
        label { font-weight: bold; margin-bottom: 2px; min-width: 160px; font-size: 18px; }
        input, select { width: 110px; padding: 8px; margin-top: 2px; font-size: 18px; }
        .full-width { grid-column: 1 / span 2; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: right; font-size: 15px; }
        th { background: #f4f4f4; cursor: help; }
        tr:hover { background: #e9f7ef; }
        .scenario-list { margin-top: 20px; }
        #plot, #netWorthGraph { margin-top: 40px; margin-bottom: 20px; }
        fieldset { border: 1px solid #ccc; padding: 15px; }
        legend { font-weight: bold; }
        .collapsible {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 18px;
            margin-top: 10px;
        }

        .active, .collapsible:hover {
            background-color: #ccc;
        }

        .content {
            padding: 0 0 10px 0;
            display: none;
            overflow: hidden;
            background-color: #f9f9f9;
        }
        .ytab {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        .ytab th, .ytab td {
            border: 1px solid #aaa;
            padding: 8px;
            text-align: center;
            position: relative;
        }
        .ytab th {
            background: #f4f4f4;
        }
        .tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            width: 220px;
            font-size: 13px;
            pointer-events: none;
        }
        .ytab td:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }
        .tabview { margin-top: 20px; }
        .tab-buttons { display: flex; gap: 12px; margin-bottom: 14px; }
        .tab-buttons button { padding: 10px 28px; border: none; background: #eee; cursor: pointer; font-size: 19px; border-radius: 4px; }
        .tab-buttons button.active { background: #ccc; font-weight: bold; }
        .tab-content { background: #f9f9f9; padding: 24px; border-radius: 6px; min-height: 120px; }
        
        /* Strategy content wrapper for smooth transitions */
        .strategy-content-wrapper {
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }
        
        /* Strategy sections */
        .strategy-section {
            margin-bottom: 18px;
            border: 2px solid #b0b0b0;
            border-radius: 8px;
            height: 280px;
            min-height: 280px;
            max-height: 280px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            min-width: 700px;
            padding: 0 32px;
        }
        .strategy-section.buy-rent { 
            background: #f8f8f8; 
            height: 320px;
            min-height: 320px;
            max-height: 320px;
        }
        .strategy-section.stocks-bonds { background: #f8f8ff; height: 170px; min-height: 170px; max-height: 170px; }
        .strategy-section.simulation { background: #f9f9f9; height: 340px; min-height: 340px; max-height: 340px; overflow: auto; }
        
        .strategy-section h3 {
            margin: 10px 0 8px 0;
            padding-left: 12px;
            font-size: 20px;
            border-bottom: 1px solid #ccc;
        }
        
        .section-content {
            display: flex;
            flex: 1;
        }
        
        /* Vertical tabs */
        .vertical-tab-buttons {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ccc;
            padding-right: 18px;
            margin-right: 18px;
        }
        
        .vertical-tab-button {
            padding: 10px 18px;
            border: none;
            background: #eee;
            cursor: pointer;
            font-size: 17px;
            border-left: 6px solid transparent;
            margin-bottom: 2px;
        }
        .vertical-tab-button.buy { border-radius: 4px 4px 0 0; }
        .vertical-tab-button.rent { border-radius: 0 0 4px 4px; margin-bottom: 0; }
        .vertical-tab-button.active { border-left-color: #0074D9; font-weight: bold; }
        
        .vertical-tab-content { flex: 1; }
        
        /* Form styling */
        .form-inputs {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .input-group.calculated {
            align-items: flex-start;
            min-width: 180px;
            position: relative;
        }
        
        .input-group.calculated .calculated-input:hover + .input-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .input-tooltip {
            visibility: hidden;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 400px;
            min-width: 250px;
            font-size: 13px;
            pointer-events: none;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.3;
        }
        
        .input-group label.calculated-label {
            color: #555;
            font-style: italic;
        }
        
        .calculated-input {
            background: #f0f0f0;
            border: 1px solid #bbb;
            color: #333;
            font-weight: bold;
        }
        
        .calculated-note {
            font-size: 12px;
            color: #888;
        }
        
        .error-message {
            color: #b00;
            font-weight: bold;
            margin: 8px 0;
        }
        
        /* Remainder section */
        .remainder-section {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            margin-bottom: 8px;
        }
        
        .split-inputs {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .split-input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .split-input-group label {
            font-size: 18px;
        }
        
        .split-input-group input {
            width: 60px;
            font-size: 18px;
            padding: 6px;
        }
        
        .split-input-group input[readonly] {
            background: #eee;
            color: #888;
        }
        
        .nominal-value {
            font-size: 16px;
            color: #888;
            margin-top: 2px;
        }
        
        /* Graph container */
        .graph-container {
            width: 100%;
            max-width: 1400px;
            height: 500px;
            margin: 40px 0 20px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fff;
            padding: 20px;
            position: relative;
        }
        
        /* Simulation controls */
        .simulation-controls {
            padding: 10px 12px;
            background: #f0f0f0;
            border-bottom: 1px solid #ccc;
            display: flex;
            align-items: center;
        }
        
        .simulation-controls label {
            font-size: 16px;
            font-weight: bold;
            min-width: auto;
        }
        
        /* Strategy management */
        .strategy-management {
            display: none; /* Hide the old strategy management bar */
        }
        
        /* Tab button improvements */
        .tab-buttons button.editable {
            position: relative;
            padding-right: 35px;
        }
        
        .tab-edit-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 12px;
            color: #666;
            padding: 2px;
        }
        
        .tab-edit-btn:hover {
            color: #333;
            background: rgba(0,0,0,0.1);
            border-radius: 2px;
        }
        
        /* Add strategy button */
        .add-strategy-tab {
            padding: 10px 16px;
            border: none;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 19px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .add-strategy-tab:hover {
            background: #45a049;
        }
        
        /* Strategy popup */
        .strategy-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .strategy-popup-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .strategy-popup h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 18px;
        }
        
        .strategy-popup-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .strategy-popup-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .strategy-popup-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .popup-btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .popup-btn-primary:hover {
            background: #45a049;
        }
        
        .popup-btn-danger {
            background: #f44336;
            color: white;
        }
        
        .popup-btn-danger:hover {
            background: #da190b;
        }
        
        .popup-btn-secondary {
            background: #ccc;
            color: #333;
        }
        
        .popup-btn-secondary:hover {
            background: #bbb;
        }
    </style>
</head>
<body>
<div class="container">
    <aside>
        <h2>Fixed Variables</h2>
        <form id="fixedVarsForm">
            <div class="form-row"><label for="cashAtHand">Cash at Hand</label><input type="number" id="cashAtHand" value="80000"></div>
            <div class="form-row"><label for="interestRate">Loan Interest Rate (%/year)</label><input type="number" id="interestRate" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="monthlyAllowance">Max Investable Monthly Allowance</label><input type="number" id="monthlyAllowance" value="1500"></div>
            <div class="form-row"><label for="avgStockReturn">Avg. Stock Return (%/year)</label><input type="number" id="avgStockReturn" step="0.01" value="8.0"></div>
            <div class="form-row"><label for="avgRealEstateReturn">Avg. Real Estate Return (%/year)</label><input type="number" id="avgRealEstateReturn" step="0.01" value="3.0"></div>
            <div class="form-row"><label for="avgBondReturn">Avg. Bond Return (%/year)</label><input type="number" id="avgBondReturn" step="0.01" value="2.0"></div>
            <div class="form-row"><label for="capitalGainsTax">Capital Gains Tax (%)</label><input type="number" id="capitalGainsTax" step="0.01" value="10.0"></div>
            <div class="form-row"><label for="prepaymentPenalty">Prepayment Penalty (% of remaining loan)</label><input type="number" id="prepaymentPenalty" step="0.01" value="1.0"></div>
            <div class="form-row"><label for="registrationTax">Registration Tax (% of house price)</label><input type="number" id="registrationTax" step="0.01" value="6.0"></div>
            <div class="form-row"><label for="maintenanceCosts">Maintenance Costs (% of house price/year)</label><input type="number" id="maintenanceCosts" step="0.01" value="1.0"></div>
            <div class="form-row"><label for="simulationYears">Simulation Years</label><input type="number" id="simulationYears" min="1" max="50" value="15"></div>
        </form>
    </aside>
    <main style="flex: 1;">
        <h1> Investment Simulator</h1>
        <div class="graph-container">
            <canvas id="plot"></canvas>
        </div>
        <div id="netWorthGraph"></div>
        <div class="tabview">
            <div class="tab-buttons" id="tabButtons"></div>
            <div class="tab-content" id="tabContent"></div>
        </div>
    </main>
</div>

<!-- Strategy Management Popup -->
<div class="strategy-popup" id="strategyPopup">
    <div class="strategy-popup-content">
        <h3 id="popupTitle">Edit Strategy</h3>
        <input type="text" id="popupStrategyName" class="strategy-popup-input" placeholder="Enter strategy name" maxlength="30">
        <div class="strategy-popup-buttons">
            <button class="popup-btn-secondary" onclick="closeStrategyPopup()">Cancel</button>
            <button class="popup-btn-danger" id="popupDeleteBtn" onclick="deleteStrategyFromPopup()" style="display: none;">Delete</button>
            <button class="popup-btn-primary" id="popupSaveBtn" onclick="saveStrategyFromPopup()">Save</button>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Make strategies array mutable and add unique IDs
let strategies = [
  { id: 1, name: "House and Stocks", splits: { realEstate: 0, stocks: 90, bonds: 10 } },
  { id: 2, name: "Rent and Stocks", splits: { realEstate: 0, stocks: 90, bonds: 10 } }
];

let currentStrategyId = 0;
let nextStrategyId = 3; // Start from 3 since we have 2 default strategies

// Store latest input values and simulation results for each strategy
let strategyInputs = strategies.map((strategy, idx) => ({
  id: strategy.id,
  mode: idx === 0 ? 'buy' : 'rent',
  housePrice: 300000,
  initialDeposit: 80000,
  loanTerm: 25,
  monthlyRent: 1500,
  stocks: 90,
  bonds: 10,
  selectedTab: idx === 0 ? 'buy' : 'rent',
  simRows: []
}));

let currentPopupStrategyIndex = -1;
let popupMode = 'edit'; // 'edit' or 'add'

// Cookie management functions
function saveStateToCookies() {
  try {
    // Save fixed variables
    const fixedVars = {
      cashAtHand: document.getElementById('cashAtHand').value,
      interestRate: document.getElementById('interestRate').value,
      monthlyAllowance: document.getElementById('monthlyAllowance').value,
      avgStockReturn: document.getElementById('avgStockReturn').value,
      avgRealEstateReturn: document.getElementById('avgRealEstateReturn').value,
      avgBondReturn: document.getElementById('avgBondReturn').value,
      capitalGainsTax: document.getElementById('capitalGainsTax').value,
      prepaymentPenalty: document.getElementById('prepaymentPenalty').value,
      registrationTax: document.getElementById('registrationTax').value,
      maintenanceCosts: document.getElementById('maintenanceCosts').value,
      simulationYears: document.getElementById('simulationYears').value
    };
    
    // Save strategies and their inputs
    const strategiesData = {
      strategies: strategies,
      strategyInputs: strategyInputs,
      nextStrategyId: nextStrategyId,
      currentStrategyId: currentStrategyId
    };
    
    // Use localStorage instead of cookies for better capacity
    localStorage.setItem('financialSimulator_fixedVars', JSON.stringify(fixedVars));
    localStorage.setItem('financialSimulator_strategies', JSON.stringify(strategiesData));
    
  } catch (error) {
    console.error('Error saving state to localStorage:', error);
  }
}

function loadStateFromCookies() {
  try {
    // Load fixed variables
    const fixedVarsData = localStorage.getItem('financialSimulator_fixedVars');
    if (fixedVarsData) {
      const fixedVars = JSON.parse(fixedVarsData);
      Object.keys(fixedVars).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
          element.value = fixedVars[key];
        }
      });
    }
    
    // Load strategies
    const strategiesData = localStorage.getItem('financialSimulator_strategies');
    if (strategiesData) {
      const data = JSON.parse(strategiesData);
      strategies = data.strategies || strategies;
      strategyInputs = data.strategyInputs || strategyInputs;
      nextStrategyId = data.nextStrategyId || nextStrategyId;
      currentStrategyId = data.currentStrategyId || currentStrategyId;
    }
    
    return true;
  } catch (error) {
    console.error('Error loading state from localStorage:', error);
    return false;
  }
}

function renderTabButtons() {
  const tabButtons = document.getElementById('tabButtons');
  tabButtons.innerHTML = '';
  
  // Render strategy tabs
  strategies.forEach((s, i) => {
    const btn = document.createElement('button');
    btn.className = i === currentStrategyId ? 'active editable' : 'editable';
    btn.innerHTML = `${s.name}<span class="tab-edit-btn" onclick="openStrategyPopup(${i}, event)" title="Edit strategy">⚙️</span>`;
    btn.onclick = (e) => {
      // Prevent edit button from triggering tab selection
      if (!e.target.classList.contains('tab-edit-btn')) {
        selectStrategyTab(i);
      }
    };
    tabButtons.appendChild(btn);
  });
  
  // Add the + button at the end
  const addBtn = document.createElement('button');
  addBtn.className = 'add-strategy-tab';
  addBtn.textContent = '+';
  addBtn.title = 'Add new strategy';
  addBtn.onclick = () => openAddStrategyPopup();
  tabButtons.appendChild(addBtn);
}

function openStrategyPopup(strategyIndex, event) {
  event.stopPropagation();
  
  currentPopupStrategyIndex = strategyIndex;
  popupMode = 'edit';
  
  const strategy = strategies[strategyIndex];
  document.getElementById('popupTitle').textContent = 'Edit Strategy';
  document.getElementById('popupStrategyName').value = strategy.name;
  document.getElementById('popupDeleteBtn').style.display = strategies.length > 1 ? 'inline-block' : 'none';
  document.getElementById('popupSaveBtn').textContent = 'Save';
  
  showStrategyPopup();
}

function openAddStrategyPopup() {
  currentPopupStrategyIndex = -1;
  popupMode = 'add';
  
  document.getElementById('popupTitle').textContent = 'Add New Strategy';
  document.getElementById('popupStrategyName').value = '';
  document.getElementById('popupDeleteBtn').style.display = 'none';
  document.getElementById('popupSaveBtn').textContent = 'Add';
  
  showStrategyPopup();
}

function showStrategyPopup() {
  const popup = document.getElementById('strategyPopup');
  popup.style.display = 'flex';
  document.getElementById('popupStrategyName').focus();
  
  // Close popup when clicking outside
  popup.onclick = (e) => {
    if (e.target === popup) {
      closeStrategyPopup();
    }
  };
}

function closeStrategyPopup() {
  document.getElementById('strategyPopup').style.display = 'none';
}

function saveStrategyFromPopup() {
  const name = document.getElementById('popupStrategyName').value.trim();
  
  if (!name) {
    alert('Please enter a strategy name');
    return;
  }
  
  // Check for duplicate names (excluding current strategy if editing)
  const isDuplicate = strategies.some((s, i) => 
    s.name === name && (popupMode === 'add' || i !== currentPopupStrategyIndex)
  );
  
  if (isDuplicate) {
    alert('Strategy name already exists');
    return;
  }
  
  if (popupMode === 'add') {
    // Create new strategy
    const newStrategy = {
      id: nextStrategyId++,
      name: name,
      splits: { realEstate: 0, stocks: 90, bonds: 10 }
    };
    
    strategies.push(newStrategy);
    
    // Create corresponding strategy input
    const newStrategyInput = {
      id: newStrategy.id,
      mode: 'buy',
      housePrice: 300000,
      initialDeposit: 80000,
      loanTerm: 25,
      monthlyRent: 1500,
      stocks: 90,
      bonds: 10,
      selectedTab: 'buy',
      simRows: []
    };
    
    strategyInputs.push(newStrategyInput);
    
    // Re-render and select the new strategy
    renderTabButtons();
    initializeAllStrategies();
    selectStrategyTab(strategies.length - 1);
  } else {
    // Update existing strategy name
    strategies[currentPopupStrategyIndex].name = name;
    renderTabButtons();
    updateNetWorthGraph(); // Update graph with new name
  }
  
  // Save state to cookies
  saveStateToCookies();
  
  closeStrategyPopup();
}

function deleteStrategyFromPopup() {
  if (strategies.length <= 1) {
    alert('Cannot remove the last strategy');
    return;
  }
  
  const strategyName = strategies[currentPopupStrategyIndex].name;
  if (!confirm(`Are you sure you want to remove "${strategyName}"?`)) {
    return;
  }
  
  // Remove strategy and its inputs
  const removedStrategyId = strategies[currentPopupStrategyIndex].id;
  strategies.splice(currentPopupStrategyIndex, 1);
  strategyInputs = strategyInputs.filter(input => input.id !== removedStrategyId);
  
  // Adjust current strategy index
  if (currentStrategyId >= strategies.length) {
    currentStrategyId = strategies.length - 1;
  } else if (currentStrategyId >= currentPopupStrategyIndex) {
    currentStrategyId = Math.max(0, currentStrategyId - 1);
  }
  
  // Re-render and update
  renderTabButtons();
  initializeAllStrategies();
  selectStrategyTab(currentStrategyId);
  
  // Save state to cookies
  saveStateToCookies();
  
  closeStrategyPopup();
}

function selectStrategyTab(idx) {
  currentStrategyId = idx;
  
  // Hide all strategy content divs
  document.querySelectorAll('.strategy-content-wrapper').forEach(div => {
    div.style.display = 'none';
  });
  
  // Show selected strategy content
  const selectedContent = document.getElementById(`strategyContent${idx}`);
  if (selectedContent) {
    selectedContent.style.display = 'block';
  }
  
  // Update button states
  document.querySelectorAll('.tab-buttons button').forEach((b, i) => {
    if (i < strategies.length) { // Only update strategy buttons, not the + button
      b.classList.toggle('active', i === idx);
    }
  });
  
  // Save state to cookies when active strategy changes
  saveStateToCookies();
}

function initializeAllStrategies() {
  const tabContent = document.getElementById('tabContent');
  
  // Create wrapper divs for each strategy
  tabContent.innerHTML = strategies.map((strategy, idx) => `
    <div id="strategyContent${idx}" class="strategy-content-wrapper" style="${idx === currentStrategyId ? 'display: block' : 'display: none'}">
      <section class="strategy-section buy-rent">
        <h3>Buy or Rent</h3>
        <div class="section-content">
          <div class="vertical-tab-buttons" id="verticalTabButtons${idx}"></div>
          <div class="vertical-tab-content" id="verticalTabContent${idx}"></div>
        </div>
      </section>
      <section class="strategy-section stocks-bonds">
        <h3>Stocks and Bonds</h3>
        <div id="remainderSection${idx}" class="section-content"></div>
      </section>
      <section class="strategy-section simulation">
        <h3>Simulation Table</h3>
        <div id="strategyTable${idx}" class="section-content"></div>
      </section>
    </div>
  `).join('');
  
  // Initialize each strategy
  strategies.forEach((_, idx) => {
    // Find corresponding strategyInput by ID
    const strategyInput = strategyInputs.find(input => input.id === strategies[idx].id);
    if (!strategyInput.selectedTab) strategyInput.selectedTab = 'buy';
    initializeStrategy(idx);
  });
  
  // Update graph once after all strategies are initialized
  updateNetWorthGraph();
}

function initializeStrategy(idx) {
  const strategyInput = strategyInputs.find(input => input.id === strategies[idx].id);
  const selectedTab = strategyInput.selectedTab;
  
  // Render tab buttons for this strategy
  const tabBtnsDiv = document.getElementById(`verticalTabButtons${idx}`);
  tabBtnsDiv.innerHTML = '';
  ['buy', 'rent'].forEach(tab => {
    const btn = document.createElement('button');
    btn.className = `vertical-tab-button ${tab}${selectedTab === tab ? ' active' : ''}`;
    btn.textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
    btn.onclick = () => {
      strategyInput.selectedTab = tab;
      renderVerticalTab(idx, tab);
    };
    tabBtnsDiv.appendChild(btn);
  });
  
  // Render tab content for this strategy
  renderVerticalTabContent(idx, selectedTab);
  updateStrategyInputs(idx);
  runStrategySimulation(idx, true); // Skip individual graph updates during init
}

function renderStrategyTab(idx) {
  const tabContent = document.getElementById('tabContent');
  const strategyInput = strategyInputs.find(input => input.id === strategies[idx].id);
  if (!strategyInput.selectedTab) strategyInput.selectedTab = 'buy';
  const selectedTab = strategyInput.selectedTab;
  
  tabContent.innerHTML = `
    <section class="strategy-section buy-rent">
      <h3>Buy or Rent</h3>
      <div class="section-content">
        <div class="vertical-tab-buttons" id="verticalTabButtons${idx}"></div>
        <div class="vertical-tab-content" id="verticalTabContent${idx}"></div>
      </div>
    </section>
    <section class="strategy-section stocks-bonds">
      <h3>Stocks and Bonds</h3>
      <div id="remainderSection${idx}" class="section-content"></div>
    </section>
    <section class="strategy-section simulation">
      <h3>Simulation Table</h3>
      <div id="strategyTable${idx}" class="section-content"></div>
    </section>
  `;
  
  renderVerticalTab(idx, selectedTab);
  updateStrategyInputs(idx);
  runStrategySimulation(idx);
}

function renderVerticalTab(idx, mode) {
  // Update tab buttons active state
  const tabBtnsDiv = document.getElementById(`verticalTabButtons${idx}`);
  tabBtnsDiv.querySelectorAll('button').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.toLowerCase() === mode);
  });
  
  // Update strategy input
  const strategyInput = strategyInputs.find(input => input.id === strategies[idx].id);
  strategyInput.selectedTab = mode;
  
  // Render tab content
  renderVerticalTabContent(idx, mode);
  updateStrategyInputs(idx);
  runStrategySimulation(idx);
  updateNetWorthGraph();
  
  // Save state to cookies when mode changes
  saveStateToCookies();
}

function renderVerticalTabContent(idx, mode) {
  // Get saved strategy input values
  const strategyInput = strategyInputs.find(input => input.id === strategies[idx].id);
  
  // Render tab content
  const tabDiv = document.getElementById(`verticalTabContent${idx}`);
  if (mode === 'buy') {
    tabDiv.innerHTML = `
      <form id="strategyForm${idx}">
        <div class="form-inputs">
          <div class="input-group">
            <label>House Price</label>
            <input type="number" name="housePrice" value="${strategyInput.housePrice || 300000}">
          </div>
          <div class="input-group">
            <label>Initial Deposit</label>
            <input type="number" name="initialDeposit" value="${strategyInput.initialDeposit || 80000}">
          </div>
          <div class="input-group calculated">
            <label class="calculated-label">Registration Costs</label>
            <div style="position: relative;">
              <input type="number" name="registrationCosts" value="24000" readonly class="calculated-input">
              <span class="input-tooltip">Registration Costs = House Price × Registration Tax Rate</span>
            </div>
            <span class="calculated-note">(calculated)</span>
            <span class="tooltip">Registration Costs = House Price × Registration Tax Rate</span>
          </div>
          <div class="input-group calculated">
            <label class="calculated-label">Loan Balance at t=0</label>
            <div style="position: relative;">
              <input type="number" name="loanBalance" value="324000" readonly class="calculated-input">
              <span class="input-tooltip">Loan Balance = House Price - Initial Deposit + Registration Costs</span>
            </div>
            <span class="calculated-note">(calculated)</span>
            <span class="tooltip">Loan Balance = House Price - Initial Deposit + Registration Costs</span>
          </div>
          <div class="input-group">
            <label>Loan Term (years)</label>
            <input type="number" name="loanTerm" value="${strategyInput.loanTerm || 25}">
          </div>
          <div class="input-group calculated">
            <label class="calculated-label">Monthly Loan Payment</label>
            <div style="position: relative;">
              <input type="number" name="monthlyRE" value="1200" readonly class="calculated-input">
              <span class="input-tooltip">Monthly Payment = (Loan Balance × Monthly Interest Rate) / (1 - (1 + Monthly Interest Rate)^(-Loan Term × 12))</span>
            </div>
            <span class="calculated-note">(calculated)</span>
            <span class="tooltip">Monthly Payment = (Loan Balance × Monthly Interest Rate) / (1 - (1 + Monthly Interest Rate)^(-Loan Term × 12))</span>
          </div>
          <div class="input-group calculated">
            <label class="calculated-label">Total Loan Repayment</label>
            <div style="position: relative;">
              <input type="number" name="totalLoanRepayment" value="0" readonly class="calculated-input">
              <span class="input-tooltip">Total Loan Repayment = Monthly Payment × 12 × Loan Term</span>
            </div>
            <span class="calculated-note">(calculated)</span>
            <span class="tooltip">Total Loan Repayment = Monthly Payment × 12 × Loan Term</span>
          </div>
          <div class="input-group calculated">
            <label class="calculated-label">Total Interest</label>
            <div style="position: relative;">
              <input type="number" name="totalInterest" value="0" readonly class="calculated-input">
              <span class="input-tooltip">Total Interest = Total Loan Repayment - Initial Loan Balance</span>
            </div>
            <span class="calculated-note">(calculated)</span>
            <span class="tooltip">Total Interest = Total Loan Repayment - Initial Loan Balance</span>
          </div>
          <div class="input-group calculated">
            <label class="calculated-label">Monthly Maintenance</label>
            <div style="position: relative;">
              <input type="number" name="monthlyMaintenance" value="333" readonly class="calculated-input">
              <span class="input-tooltip">Monthly Maintenance = House Price × Maintenance Rate / 12</span>
            </div>
            <span class="calculated-note">(calculated)</span>
            <span class="tooltip">Monthly Maintenance = House Price × Maintenance Rate / 12</span>
          </div>
        </div>
        <div id="monthlyAllowanceMsg${idx}" class="error-message"></div>
      </form>
    `;
  } else {
    tabDiv.innerHTML = `
      <form id="strategyForm${idx}">
        <div class="form-inputs">
          <div class="input-group">
            <label>Monthly Rent</label>
            <input type="number" name="monthlyRent" value="${strategyInput.monthlyRent || 1500}">
          </div>
        </div>
        <div id="monthlyAllowanceMsg${idx}" class="error-message"></div>
      </form>
    `;
  }
  
  // Add event listeners
  const form = document.getElementById(`strategyForm${idx}`);
  const fieldNames = mode === 'buy' ? ['housePrice', 'initialDeposit', 'loanTerm'] : ['monthlyRent'];
  fieldNames.forEach(name => {
    if (form[name]) {
      form[name].addEventListener('input', () => {
        updateStrategyInputs(idx);
        runStrategySimulation(idx);
        updateNetWorthGraph();
        
        // Save state to cookies when strategy inputs change
        saveStateToCookies();
      });
    }
  });
}

function updateStrategyInputs(idx) {
  const form = document.getElementById(`strategyForm${idx}`);
  const mode = form && form.monthlyRent ? 'rent' : 'buy';
  const strategyInput = strategyInputs.find(input => input.id === strategies[idx].id);
  strategyInput.mode = mode;
  
  const fixed = {
    cashAtHand: +document.getElementById('cashAtHand').value,
    monthlyAllowance: +document.getElementById('monthlyAllowance').value,
    interestRate: +document.getElementById('interestRate').value
  };
  
  let remainder = 0;
  const msgDiv = document.getElementById(`monthlyAllowanceMsg${idx}`);
  
  if (mode === 'buy') {
    const housePrice = +form.housePrice.value;
    const initialDeposit = +form.initialDeposit.value;
    const loanTerm = +form.loanTerm.value;
    
    // Save input values to strategyInputs
    strategyInput.housePrice = housePrice;
    strategyInput.initialDeposit = initialDeposit;
    strategyInput.loanTerm = loanTerm;
    
    // Calculate all the financial values
    const registrationTaxRate = +document.getElementById('registrationTax').value;
    const registrationCosts = housePrice * (registrationTaxRate / 100);
    const loanBalance = housePrice - initialDeposit + registrationCosts;
    
    const monthlyLoanRate = (fixed.interestRate / 100) / 12;
    const monthlyRE = loanBalance * monthlyLoanRate / (1 - Math.pow(1 + monthlyLoanRate, -loanTerm * 12));
    const totalLoanRepayment = monthlyRE * 12 * loanTerm;
    const totalInterest = totalLoanRepayment - loanBalance;
    const maintenanceRate = +document.getElementById('maintenanceCosts').value;
    const monthlyMaintenance = housePrice * (maintenanceRate / 100) / 12;
    
    // Update all calculated fields
    form.registrationCosts.value = registrationCosts.toFixed(2);
    form.loanBalance.value = loanBalance.toFixed(2);
    form.monthlyRE.value = monthlyRE.toFixed(2);
    form.totalLoanRepayment.value = totalLoanRepayment.toFixed(2);
    form.totalInterest.value = totalInterest.toFixed(2);
    form.monthlyMaintenance.value = monthlyMaintenance.toFixed(2);
    
    // Update tooltips with actual values
    const registrationTooltip = form.querySelector('[name="registrationCosts"]').parentElement.querySelector('.tooltip');
    const registrationInputTooltip = form.querySelector('[name="registrationCosts"]').nextElementSibling;
    if (registrationTooltip) {
      registrationTooltip.textContent = `Registration Costs = House Price (${housePrice.toLocaleString()}) × Registration Tax Rate (${registrationTaxRate}%)`;
    }
    if (registrationInputTooltip) {
      registrationInputTooltip.textContent = `Registration Costs = House Price (${housePrice.toLocaleString()}) × Registration Tax Rate (${registrationTaxRate}%)`;
    }
    
    const loanBalanceTooltip = form.querySelector('[name="loanBalance"]').parentElement.parentElement.querySelector('.tooltip');
    const loanBalanceInputTooltip = form.querySelector('[name="loanBalance"]').nextElementSibling;
    if (loanBalanceTooltip) {
      loanBalanceTooltip.textContent = `Loan Balance = House Price (${housePrice.toLocaleString()}) - Initial Deposit (${initialDeposit.toLocaleString()}) + Registration Costs (${registrationCosts.toLocaleString()})`;
    }
    if (loanBalanceInputTooltip) {
      loanBalanceInputTooltip.textContent = `Loan Balance = House Price (${housePrice.toLocaleString()}) - Initial Deposit (${initialDeposit.toLocaleString()}) + Registration Costs (${registrationCosts.toLocaleString()})`;
    }
    
    const monthlyRETooltip = form.querySelector('[name="monthlyRE"]').parentElement.parentElement.querySelector('.tooltip');
    const monthlyREInputTooltip = form.querySelector('[name="monthlyRE"]').nextElementSibling;
    if (monthlyRETooltip) {
      monthlyRETooltip.textContent = `Monthly Payment = Loan Balance (${loanBalance.toLocaleString()}) × Monthly Interest Rate (${(monthlyLoanRate * 100).toFixed(3)}%) / (1 - (1 + Monthly Interest Rate)^(-Loan Term (${loanTerm}) × 12))`;
    }
    if (monthlyREInputTooltip) {
      monthlyREInputTooltip.textContent = `Monthly Payment = Loan Balance (${loanBalance.toLocaleString()}) × Monthly Interest Rate (${(monthlyLoanRate * 100).toFixed(3)}%) / (1 - (1 + Monthly Interest Rate)^(-Loan Term (${loanTerm}) × 12))`;
    }
    
    const maintenanceTooltip = form.querySelector('[name="monthlyMaintenance"]').parentElement.parentElement.querySelector('.tooltip');
    const maintenanceInputTooltip = form.querySelector('[name="monthlyMaintenance"]').nextElementSibling;
    if (maintenanceTooltip) {
      maintenanceTooltip.textContent = `Monthly Maintenance = House Price (${housePrice.toLocaleString()}) × Maintenance Rate (${maintenanceRate}%) / 12`;
    }
    if (maintenanceInputTooltip) {
      maintenanceInputTooltip.textContent = `Monthly Maintenance = House Price (${housePrice.toLocaleString()}) × Maintenance Rate (${maintenanceRate}%) / 12`;
    }
    
    // Validate initial deposit against cash at hand
    if (initialDeposit > fixed.cashAtHand) {
      msgDiv.textContent = `Error: Initial deposit (${initialDeposit.toFixed(2)}) exceeds cash at hand (${fixed.cashAtHand})!`;
    } else {
      msgDiv.textContent = '';
    }
    
    remainder = fixed.monthlyAllowance - monthlyRE - monthlyMaintenance;
    
  } else {
    const monthlyRent = +form.monthlyRent.value;
    // Save input values to strategyInputs
    strategyInput.monthlyRent = monthlyRent;
    strategyInput.loanTerm = 30;
    remainder = fixed.monthlyAllowance - monthlyRent;
  }
  
  updateRemainderSection(idx, remainder, mode, fixed.monthlyAllowance);
}

function updateRemainderSection(idx, remainder, mode, monthlyAllowance) {
  const remainderSection = document.getElementById(`remainderSection${idx}`);
  const form = document.getElementById(`strategyForm${idx}`);
  
  const remainderValue = remainder > 0 ? remainder.toFixed(2) : 0;
  const tooltipText = mode === 'buy' 
    ? `Remainder = Monthly Allowance - Loan Payment - Maintenance`
    : `Remainder = Monthly Allowance - Monthly Rent`;
  
  // Calculate remainder after loan is repaid (for buy mode only)
  let remainderAfterLoan = remainderValue;
  let afterLoanText = '';
  if (mode === 'buy' && form && form.monthlyRE) {
    const housePrice = +form.housePrice.value;
    const maintenanceRate = +document.getElementById('maintenanceCosts').value;
    const monthlyMaintenance = housePrice * (maintenanceRate / 100) / 12;
    remainderAfterLoan = (monthlyAllowance - monthlyMaintenance).toFixed(2);
    afterLoanText = ` (After loan repaid: ${remainderAfterLoan})`;
  }
  
    remainderSection.innerHTML = `
    <div class="remainder-section">
      <div class="input-group calculated">
        <label class="calculated-label">Remainder for Stocks/Bonds</label>
        <div style="position: relative;">
          <input type="number" name="monthlyRemainder" value="${remainderValue}" readonly class="calculated-input">
          <span class="input-tooltip">${tooltipText}${afterLoanText}</span>
        </div>
        <span class="calculated-note">(calculated)${afterLoanText}</span>
        <span class="tooltip">${tooltipText}${afterLoanText}</span>
      </div>
      <div id="splitInputs${idx}" class="split-inputs"></div>
    </div>
    <div id="remainderMsg${idx}" class="error-message"></div>
  `;  // Show split inputs only if remainder > 0
  const splitDiv = document.getElementById(`splitInputs${idx}`);
  if (remainder > 0) {
    const stocksPct = strategies[idx].splits.stocks;
    const bondsPct = 100 - stocksPct;
    const stocksVal = (remainder * stocksPct / 100).toFixed(2);
    const bondsVal = (remainder * bondsPct / 100).toFixed(2);
    
    splitDiv.innerHTML = `
      <div class="split-input-group">
        <label>Stocks %</label>
        <input type="number" name="stocks" min="0" max="100" value="${stocksPct}">
        <span class="nominal-value">${stocksVal}</span>
      </div>
      <div class="split-input-group">
        <label>Bonds %</label>
        <input type="number" name="bonds" value="${bondsPct}" readonly>
        <span class="nominal-value">${bondsVal}</span>
      </div>
    `;
    
    // Add listener for stocks input
    splitDiv.querySelector("[name='stocks']").addEventListener('input', (e) => {
      let stocksPctNew = Math.max(0, Math.min(100, +e.target.value));
      const bondsPctNew = 100 - stocksPctNew;
      
      strategies[idx].splits.stocks = stocksPctNew;
      splitDiv.querySelector("[name='bonds']").value = bondsPctNew;
      splitDiv.querySelector(".nominal-value").textContent = (remainder * stocksPctNew / 100).toFixed(2);
      splitDiv.querySelectorAll(".nominal-value")[1].textContent = (remainder * bondsPctNew / 100).toFixed(2);
      
      runStrategySimulation(idx);
      updateNetWorthGraph();
      
      // Save state to cookies when splits change
      saveStateToCookies();
    });
  }
  
  // Error message for negative remainder
  const remainderMsg = document.getElementById(`remainderMsg${idx}`);
  if (remainder < 0) {
    const errorText = mode === 'buy' 
      ? 'Error: Monthly real estate payment plus maintenance exceeds max investable monthly allowance! This simulation will go into a debt spiral !!'
      : 'Error: Monthly rent exceeds max investable monthly allowance! The simulation will go into a debt spiral !!';
    remainderMsg.textContent = errorText;
  } else {
    remainderMsg.textContent = '';
  }
}

function addFixedVarListeners() {
  const fixedForm = document.getElementById('fixedVarsForm');
  Array.from(fixedForm.elements).forEach(el => {
    el.addEventListener('input', () => {
      if (el.id === 'simulationYears') {
        // When simulation years change, update all strategies
        strategies.forEach((_, idx) => {
          runStrategySimulation(idx, true);
        });
        updateNetWorthGraph();
      } else {
        // Re-render current tab and update graph for other fixed variables
        renderStrategyTab(currentStrategyId);
        updateNetWorthGraph();
      }
      // Save state to cookies when fixed variables change
      saveStateToCookies();
    });
  });
  
  // Add keyboard support for popup
  document.addEventListener('keydown', (e) => {
    const popup = document.getElementById('strategyPopup');
    if (popup.style.display === 'flex') {
      if (e.key === 'Escape') {
        closeStrategyPopup();
      } else if (e.key === 'Enter') {
        saveStrategyFromPopup();
      }
    }
  });
}

function runStrategySimulation(idx, skipGraphUpdate = false) {
  // Get fixed vars
  const fixed = {
    cashAtHand: +document.getElementById('cashAtHand').value,
    interestRate: +document.getElementById('interestRate').value,
    monthlyAllowance: +document.getElementById('monthlyAllowance').value,
    avgStockReturn: +document.getElementById('avgStockReturn').value,
    avgRealEstateReturn: +document.getElementById('avgRealEstateReturn').value,
    avgBondReturn: +document.getElementById('avgBondReturn').value,
    capitalGainsTax: +document.getElementById('capitalGainsTax').value,
    prepaymentPenalty: +document.getElementById('prepaymentPenalty').value,
    registrationTax: +document.getElementById('registrationTax').value,
    maintenanceCosts: +document.getElementById('maintenanceCosts').value
  };
  // Get strategy vars
  const form = document.getElementById(`strategyForm${idx}`);
  let mode = 'buy';
  if (form && form.monthlyRent) mode = 'rent';
  let housePrice = 0, initialDeposit = 0, loanTerm = 0, monthlyRE = 0, monthlyRemainder = 0;
  let stocks = strategies[idx].splits.stocks, bonds = strategies[idx].splits.bonds;
  if (form) {
    if (mode === 'buy') {
      housePrice = form.housePrice ? +form.housePrice.value : 0;
      initialDeposit = form.initialDeposit ? +form.initialDeposit.value : 0;
      loanTerm = form.loanTerm ? +form.loanTerm.value : 0;
      monthlyRE = form.monthlyRE ? +form.monthlyRE.value : 0;
      
      // Calculate maintenance costs
      const maintenanceRate = +document.getElementById('maintenanceCosts').value;
      const monthlyMaintenance = housePrice * (maintenanceRate / 100) / 12;
      
      // Calculate remainder for buy mode
      monthlyRemainder = fixed.monthlyAllowance - monthlyRE - monthlyMaintenance;
    } else {
      // Rent mode: set buy-related fields to zero/defaults
      housePrice = 0;
      initialDeposit = 0;
      loanTerm = 30; // Default simulation length for rent
      monthlyRE = 0;
      
      // Calculate remainder for rent mode
      const monthlyRent = form.monthlyRent ? +form.monthlyRent.value : 0;
      monthlyRemainder = fixed.monthlyAllowance - monthlyRent;
    }
    // Get stocks/bonds percentages from form if available
    const stocksInput = form.querySelector("[name='stocks']");
    const bondsInput = form.querySelector("[name='bonds']");
    if (stocksInput && bondsInput) {
      stocks = +stocksInput.value;
      bonds = +bondsInput.value;
    }
  } else {
    // fallback to default strategy values if form not rendered yet
    housePrice = 300000;
    initialDeposit = 80000;
    loanTerm = 30;
    monthlyRE = 1200;
    monthlyRemainder = 800;
  }
  const result = simulateStrategy(fixed, housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds, idx);
  const strategyInput = strategyInputs.find(input => input.id === strategies[idx].id);
  strategyInput.simRows = result;
  renderStrategyTable(idx, result);
  // Only update the graph if not skipping
  if (!skipGraphUpdate) {
    updateNetWorthGraph(idx);
  }
}

function simulateStrategy(fixed, housePrice, initialDeposit, loanTerm, monthlyRE, monthlyRemainder, stocks, bonds, strategyIdx) {
  // Get simulation years from the central input field
  const simulationYears = +document.getElementById('simulationYears').value;
  let rows = [];
  
  // Initial setup
  let registrationTax = housePrice * (fixed.registrationTax/100);
  let realEstateValue = housePrice;
  let loanBalance = 0;
  let investedCash = 0;
  let totalLoanRepayment = 0;
  let remainingLoanRepayment = 0;
  
  if (housePrice > 0) {
    // Buy scenario
    investedCash = fixed.cashAtHand - initialDeposit;
    loanBalance = housePrice - initialDeposit + registrationTax;
    totalLoanRepayment = monthlyRE * 12 * loanTerm;
    remainingLoanRepayment = totalLoanRepayment;
  } else {
    // Rent scenario - all cash goes to investments
    investedCash = fixed.cashAtHand;
    realEstateValue = 0;
  }
  
  // At t=0, add monthly leftover to initial stock/bond balance
  let monthlyStockInvestment = monthlyRemainder * (stocks/100);
  let monthlyBondInvestment = monthlyRemainder * (bonds/100);
  let stockBalance = investedCash * (stocks/100) + monthlyStockInvestment * 12;
  let bondBalance = investedCash * (bonds/100) + monthlyBondInvestment * 12;

  // Track cost basis for capital gains tax calculation
  let stockCostBasis = investedCash * (stocks/100) + monthlyStockInvestment * 12;
  let bondCostBasis = investedCash * (bonds/100) + monthlyBondInvestment * 12;

  for (let y = 0; y <= simulationYears; y++) {
    let penalty = 0;
    if (loanBalance > 0 && y < loanTerm) {
      penalty = loanBalance * (fixed.prepaymentPenalty/100);
    }

    // Track monthly investment amount for this year
    let monthlyInvestment = monthlyRemainder;

    if (y > 0) {
      if (realEstateValue > 0) {
        realEstateValue *= (1 + fixed.avgRealEstateReturn/100);
      }

      // If loan is still active, amortize it
      if (y < loanTerm && loanBalance > 0) {
        // Calculate annual payments and interest
        let totalAnnualPayment = monthlyRE * 12;
        let annualInterest = loanBalance * (fixed.interestRate/100);
        let principalPaid = Math.min(totalAnnualPayment - annualInterest, loanBalance);
        
        // Update loan tracking
        loanBalance -= principalPaid;
        remainingLoanRepayment -= totalAnnualPayment;
        
        if (loanBalance < 0) loanBalance = 0;
        if (remainingLoanRepayment < 0) remainingLoanRepayment = 0;
      } else if (housePrice > 0 && loanBalance > 0) {
        // Loan term has ended - set loan balance to 0 and redirect payments to investments
        loanBalance = 0;
        remainingLoanRepayment = 0;
        monthlyInvestment += monthlyRE;
      } else if (housePrice > 0 && loanBalance === 0) {
        // Loan is already paid off - redirect monthly loan payment to investments
        remainingLoanRepayment = 0;
        monthlyInvestment += monthlyRE;
      }

      // Invest the available money in stocks and bonds
      monthlyStockInvestment = monthlyInvestment * (stocks/100);
      monthlyBondInvestment = monthlyInvestment * (bonds/100);

      // New formula: previous_balance * (1+return) + monthly_investment*12
      stockBalance = stockBalance * (1 + fixed.avgStockReturn/100) + monthlyStockInvestment * 12;
      bondBalance = bondBalance * (1 + fixed.avgBondReturn/100) + monthlyBondInvestment * 12;
      
      // Update cost basis with new investments
      stockCostBasis += monthlyStockInvestment * 12;
      bondCostBasis += monthlyBondInvestment * 12;
    }
    
    // Calculate capital gains tax (assuming liquidation) - only on stocks
    let stockGains = Math.max(0, stockBalance - stockCostBasis);
    let capitalGainsTax = stockGains * (fixed.capitalGainsTax / 100);
    
    let netWorth = realEstateValue + stockBalance + bondBalance - loanBalance - penalty - capitalGainsTax;
    let row = {
      year: y,
      realEstateValue,
      monthlyInvestment,
      stockBalance,
      bondBalance,
      stockCostBasis,
      bondCostBasis,
      capitalGainsTax,
      loanBalance,
      remainingLoanRepayment,
      penalty,
      maintenance: 0,
      netWorth
    };
    rows.push(row);
    lastRow = row;
  }
  return rows;
}

function renderStrategyTable(idx, rows) {
  let html = `<table class="ytab"><thead><tr>
    <th>Year</th>
    <th>Real Estate Value</th>
    <th>Stocks/Bonds Cash Injection</th>
    <th>Stock Value</th>
    <th>Stocks Cost</th>
    <th>Bond Value</th>
    <th>Capital Gains Tax</th>
    <th>Loan Balance</th>
    <th>Remaining Loan Repayment</th>
    <th>Prepayment Penalty</th>
    <th>Net Worth</th>
  </tr></thead><tbody>`;
  for (const r of rows) {
    html += `<tr>
      <td>${r.year}</td>
      <td>${r.realEstateValue.toFixed(2)}<span class="tooltip">Real Estate Value = Previous × (1 + Real Estate Return)</span></td>
      <td>${r.monthlyInvestment?.toFixed(2) || '0.00'}<span class="tooltip">Monthly amount available for stocks/bonds investment</span></td>
      <td>${r.stockBalance.toFixed(2)}<span class="tooltip">Stock Value = Previous × (1 + Stock Return) + Monthly Stock Investment × 12</span></td>
      <td>${r.stockCostBasis?.toFixed(2) || '0.00'}<span class="tooltip">Stocks Cost = Total amount invested in stocks over time</span></td>
      <td>${r.bondBalance.toFixed(2)}<span class="tooltip">Bond Value = Previous × (1 + Bond Return) + Monthly Bond Investment × 12<br/>Treated as term deposit (no capital gains tax)</span></td>
      <td>${r.capitalGainsTax?.toFixed(2) || '0.00'}<span class="tooltip">(Stock Value - Stocks Cost) × Capital Gains Tax Rate<br/>(${r.stockBalance?.toFixed(2) || '0.00'} - ${r.stockCostBasis?.toFixed(2) || '0.00'}) × ${document.getElementById('capitalGainsTax')?.value || '10'}%</span></td>
      <td>${r.loanBalance.toFixed(2)}<span class="tooltip">Loan Balance = Remaining principal amount owed</span></td>
      <td>${r.remainingLoanRepayment?.toFixed(2) || '0.00'}<span class="tooltip">Remaining Total Repayment = Total amount still to be paid over remaining loan term</span></td>
      <td>${r.penalty.toFixed(2)}<span class="tooltip">Prepayment Penalty = Remaining Loan × Penalty Rate (if not last year)</span></td>
      <td>${r.netWorth.toFixed(2)}<span class="tooltip">Net Worth = Real Estate + Stocks + Bonds - Loan Balance - Penalty - Capital Gains Tax (stocks only)</span></td>
    </tr>`;
  }
  html += '</tbody></table>';
  const tableDiv = document.getElementById(`strategyTable${idx}`);
  if (tableDiv) tableDiv.innerHTML = html;
}

function updateNetWorthGraph(changedIdx) {
  // Always show all graphs, but only update the changed strategy's data if changedIdx is provided
  const cashAtHand = +document.getElementById('cashAtHand').value;
  // Find the union of all years across all strategies
  let allYears = new Set();
  for (let i = 0; i < strategies.length; i++) {
    const strategyInput = strategyInputs.find(input => input.id === strategies[i].id);
    const simRows = strategyInput ? strategyInput.simRows || [] : [];
    simRows.forEach(r => allYears.add(r.year));
  }
  if (allYears.size === 0) return;
  let years = Array.from(allYears).sort((a, b) => a - b);
  years = [-1, ...years];
  // Build datasets for all strategies
  let datasets = strategies.map((s, idx) => {
    const strategyInput = strategyInputs.find(input => input.id === s.id);
    const simRows = strategyInput ? strategyInput.simRows || [] : [];
    const data = years.map(y => {
      if (y === -1) return cashAtHand;
      const row = simRows.find(r => r.year === y);
      return row ? row.netWorth : null;
    });
    return {
      label: s.name,
      data,
      borderColor: idx === 0 ? 'blue' : idx === 1 ? 'green' : idx === 2 ? 'orange' : `hsl(${idx * 60}, 70%, 50%)`,
      fill: false,
      tension: 0.1
    };
  });
  const ctx = document.getElementById('plot').getContext('2d');
  if (window.resultChart) window.resultChart.destroy();
  window.resultChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: years,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: { enabled: true }
      },
      scales: {
        x: { title: { display: true, text: 'Year' } },
        y: {
          title: { display: true, text: 'Net Worth' },
          beginAtZero: true,
          suggestedMin: 0,
          suggestedMax: Math.max(...datasets.flatMap(ds => ds.data.filter(v => v !== null))) * 1.1
        }
      }
    }
  });
}

window.onload = function() {
  // Load state from localStorage first
  loadStateFromCookies();
  
  // Then initialize the UI
  renderTabButtons();
  initializeAllStrategies();
  addFixedVarListeners();
};
</script>
</body>
</html>
